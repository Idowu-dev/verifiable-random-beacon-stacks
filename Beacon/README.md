# Verifiable Random Beacon Service Smart Contract

This smart contract implements a **Verifiable Random Beacon Service** using a **commit-reveal** pattern for generating secure random numbers. It ensures that the random numbers generated can be verified by all parties, promoting transparency and fairness in decentralized applications that require randomness.

## Features
1. **Validator Registration**: Validators can register with a stake to participate in the random number generation process.
2. **Commit Phase**: Validators commit to a secret value, which is hashed for future verification.
3. **Reveal Phase**: Validators reveal their committed value, and the service verifies the consistency of the commitment and reveal.
4. **Random Seed Generation**: A random seed is generated by combining the commitments and reveals from multiple validators.
5. **Staking and Withdrawals**: Validators stake tokens to participate and can withdraw their stake once the process is complete.
6. **Security**: The contract utilizes a combination of `commitment` and `reveal` patterns to prevent manipulation, ensuring the integrity of the generated random number.

## Phases

### 1. Register Validator
Validators must stake a certain amount of tokens to participate in the random beacon process. The contract ensures that the validator’s stake is valid and the maximum number of validators is not exceeded.

**Function:** `register-validator`

**Conditions:**
- The contract is not in any ongoing phase (`none`).
- The validator’s account balance must be sufficient to cover the required stake.
- The number of validators must not exceed the maximum limit.

---

### 2. Start Commit Phase
The commit phase begins after enough validators have been registered. In this phase, validators commit a secret value, which will later be revealed.

**Function:** `start-commit-phase`

**Conditions:**
- The contract is not in any ongoing phase (`none`).
- There must be enough validators (at least the minimum required).
  
---

### 3. Submit Commitment
During the commit phase, validators submit their commitments, which are cryptographic hashes of their chosen values. Once committed, the validator cannot change their value.

**Function:** `submit-commitment`

**Conditions:**
- The contract is in the commit phase.
- The validator has not yet submitted a commitment.
- The commit phase has not yet ended.

---

### 4. Start Reveal Phase
After the commit phase ends, the reveal phase begins. Validators are required to reveal their committed values within a given time window.

**Function:** `start-reveal-phase`

**Conditions:**
- The commit phase has ended.
- The reveal phase has not yet started.

---

### 5. Reveal Commitment
Validators reveal their committed values during the reveal phase. The contract verifies the consistency of the reveal with the commitment, ensuring no cheating has occurred.

**Function:** `reveal-commitment`

**Conditions:**
- The contract is in the reveal phase.
- The validator’s revealed value matches their committed value.

---

### 6. Finalize Random Seed
Once all validators have revealed their values, the random seed is finalized. The seed is generated by combining the revealed values of all validators, providing a secure and verifiable random number.

**Function:** `finalize-random-seed`

**Conditions:**
- The contract is in the reveal phase.
- The reveal window has ended.
  
The final random seed can be retrieved using the request ID.

---

### 7. Withdraw Stake
Validators can withdraw their stake once the process is complete, provided no active phase is ongoing. The validator’s stake is returned to them minus any penalties if applicable.

**Function:** `withdraw-stake`

**Conditions:**
- The contract is not in any ongoing phase (`none`).
- The validator has successfully participated or withdrawn their stake.

---

## Data Structures

### Constants:
- **CONTRACT_OWNER**: The owner of the contract.
- **VALIDATOR_STAKE**: The stake amount required to register as a validator.
- **COMMIT_WINDOW**: The time window for validators to commit (3 minutes in blocks).
- **REVEAL_WINDOW**: The time window for validators to reveal their commitment (1 minute in blocks).
- **MIN_VALIDATORS**: Minimum number of validators required to start the commit phase.
- **MAX_VALIDATORS**: Maximum number of validators allowed to register.

### Error Codes:
- **ERR_NOT_AUTHORIZED**: Raised when an unauthorized action is attempted.
- **ERR_INVALID_STAKE**: Raised when a validator has insufficient stake.
- **ERR_TOO_MANY_VALIDATORS**: Raised when too many validators have registered.
- **ERR_COMMIT_PHASE_ENDED**: Raised when an attempt is made to commit after the commit phase has ended.
- **ERR_REVEAL_PHASE_ENDED**: Raised when an attempt is made to reveal after the reveal phase has ended.
- **ERR_ALREADY_COMMITTED**: Raised when a validator attempts to commit more than once.
- **ERR_NO_COMMITMENT_FOUND**: Raised when a validator’s commitment is not found.
- **ERR_INVALID_REVEAL**: Raised when a revealed value does not match the stored commitment.
- **ERR_NOT_ENOUGH_VALIDATORS**: Raised when there are not enough validators to start the commit phase.

### Data Variables:
- **current-request-id**: A unique identifier for each random seed request.
- **current-phase**: The current phase of the process (`none`, `commit`, or `reveal`).
- **phase-start-block**: The block height at which the current phase started.
- **validator-count**: The number of validators currently registered.

### Data Maps:
- **validators**: A map storing registered validators.
- **commitments**: A map storing the commitment data for each validator in each request.
- **random-seeds**: A map storing the finalized random seed for each request.
- **validator-stakes**: A map storing the stake amount of each validator.

## Security Considerations
- **Commit-Reveal Integrity**: The commit-reveal pattern prevents validators from manipulating their revealed values by ensuring that their commitments are public before they reveal the corresponding values.
- **Stake Penalties**: Validators who behave maliciously or fail to reveal their values will be penalized by losing their stake.
- **Transparency**: The generated random seeds are publicly available and can be verified by any party to ensure fairness.

## Example Workflow

1. **Register a Validator**: A user stakes 1000 STX and registers as a validator.
2. **Start Commit Phase**: Once there are enough validators, the commit phase starts. Validators commit their secret values.
3. **Start Reveal Phase**: After the commit phase ends, validators reveal their committed values.
4. **Finalize Random Seed**: Once all validators have revealed their values, the random seed is generated and made available for use.